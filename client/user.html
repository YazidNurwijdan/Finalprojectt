<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <title>Marketplace | PhotoMarket</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style> body { font-family: 'Inter', sans-serif; } </style>
</head>
<body class="bg-gray-50 min-h-screen pb-32">
    <nav class="bg-white border-b border-gray-200 sticky top-0 z-40 px-6 py-4 flex justify-between items-center">
        <span class="font-bold text-xl text-indigo-600">PhotoMarket.</span>
        <button onclick="localStorage.clear(); window.location.href='index.html'" class="text-sm text-gray-500 hover:text-red-600">Keluar</button>
    </nav>

    <div class="max-w-7xl mx-auto px-6 py-10">
        <h2 class="text-3xl font-bold text-gray-900 mb-2">Katalog Foto</h2>
        <p class="text-gray-500 mb-8">Dapatkan API Key untuk mengakses foto resolusi tinggi.</p>
        <div id="gallery" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
    </div>

    <div class="fixed bottom-0 left-0 w-full z-50 px-4 pb-4">
        <div class="max-w-5xl mx-auto bg-white rounded-xl shadow-2xl border border-gray-200 overflow-hidden">
            <div class="bg-gray-900 px-6 py-3 flex justify-between items-center cursor-pointer" onclick="toggleViewer()">
                <div class="flex items-center gap-2 text-white"><i data-lucide="image" class="w-4 h-4"></i><span class="text-sm font-medium">Photo Viewer & API Tester</span></div>
                <i data-lucide="chevron-up" id="viewerIcon" class="text-gray-400 w-4 h-4 transition-transform"></i>
            </div>
            <div id="viewerBody" class="h-0 transition-all duration-300 flex flex-col md:flex-row bg-gray-50">
                <div class="p-6 md:w-1/3 border-r border-gray-200 space-y-4 bg-white">
                    <input type="text" id="inputPhotoId" class="w-full border p-2 rounded text-sm" placeholder="ID Foto">
                    <input type="text" id="inputApiKey" class="w-full border p-2 rounded text-sm" placeholder="Paste API Key">
                    <button onclick="viewPhoto()" class="w-full bg-indigo-600 text-white py-2 rounded text-sm hover:bg-indigo-700">Ambil Data</button>
                </div>
                <div class="md:w-2/3 bg-gray-200 flex items-center justify-center relative overflow-hidden">
                    <div id="resultArea" class="p-4 text-center text-gray-500 text-sm">Preview muncul disini</div>
                </div>
            </div>
        </div>
    </div>

    <div id="modal" class="fixed inset-0 bg-black/50 hidden flex items-center justify-center z-50">
        <div class="bg-white p-6 rounded-xl max-w-md w-full m-4 text-center">
            <div class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4"><i data-lucide="check" class="text-green-600 w-6 h-6"></i></div>
            <h3 class="text-lg font-bold">Pembelian Berhasil!</h3>
            <div class="bg-gray-100 p-3 rounded-lg my-4 flex justify-between items-center">
                <code id="keyDisplay" class="text-indigo-600 text-sm font-mono truncate mr-2"></code>
                <button onclick="copyKey()"><i data-lucide="copy" class="w-4 h-4 text-gray-500"></i></button>
            </div>
            <button onclick="closeModal()" class="w-full bg-indigo-600 text-white py-2 rounded">Tutup</button>
        </div>
    </div>

    <script>
        lucide.createIcons();
        let isViewerOpen = false;
        function toggleViewer() {
            const body = document.getElementById('viewerBody');
            isViewerOpen = !isViewerOpen;
            body.style.height = isViewerOpen ? "320px" : "0px";
            document.getElementById('viewerIcon').style.transform = isViewerOpen ? "rotate(180deg)" : "rotate(0deg)";
        }

        async function loadPhotos() {
            const res = await fetch('http://localhost:3000/photos');
            const photos = await res.json();
            document.getElementById('gallery').innerHTML = photos.map(p => `
                <div class="bg-white border border-gray-200 rounded-xl overflow-hidden hover:shadow-lg transition">
                    <div class="h-48 bg-gray-100 flex flex-col items-center justify-center border-b border-gray-100">
                        <i data-lucide="lock" class="text-gray-400 w-8 h-8 mb-2"></i><span class="text-xs font-bold text-gray-400 uppercase">Konten Terkunci</span>
                    </div>
                    <div class="p-5 flex flex-col h-[200px]">
                        <div class="flex justify-between items-start mb-2"><h3 class="font-bold text-gray-900 truncate w-3/4">${p.title}</h3><span class="bg-gray-100 text-xs px-2 py-1 rounded">ID: ${p.id}</span></div>
                        <p class="text-gray-500 text-sm line-clamp-2 mb-4 flex-grow">${p.description || 'Tidak ada deskripsi.'}</p>
                        <div class="flex items-center justify-between border-t pt-4">
                            <span class="font-bold text-indigo-600">Rp ${Number(p.price).toLocaleString('id-ID')}</span>
                            <button onclick="buyPhoto(${p.id})" class="bg-gray-900 text-white px-4 py-2 rounded text-sm hover:bg-black">Beli Akses</button>
                        </div>
                    </div>
                </div>
            `).join('');
            lucide.createIcons();
        }

        async function buyPhoto(id) {
            const uid = localStorage.getItem('user_id');
            const res = await fetch('http://localhost:3000/transaction/buy', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({user_id:uid, photo_id:id})});
            const data = await res.json();
            if(data.success) {
                document.getElementById('keyDisplay').innerText = data.api_key;
                document.getElementById('modal').classList.remove('hidden');
            }
        }

        function copyKey() {
            const k = document.getElementById('keyDisplay').innerText;
            navigator.clipboard.writeText(k);
            document.getElementById('inputApiKey').value = k;
            alert('Copied!');
        }

        function closeModal() {
            document.getElementById('modal').classList.add('hidden');
            if(!isViewerOpen) toggleViewer();
        }

        async function viewPhoto() {
            const k = document.getElementById('inputApiKey').value;
            const id = document.getElementById('inputPhotoId').value;
            const area = document.getElementById('resultArea');
            area.innerHTML = 'Loading...';
            try {
                const res = await fetch(`http://localhost:3000/access/photo/${id}`, {headers:{'x-api-key':k}});
                if(res.ok) {
                    const blob = await res.blob();
                    area.innerHTML = `<img src="${URL.createObjectURL(blob)}" class="max-h-full object-contain">`;
                } else area.innerHTML = 'Akses Ditolak / Key Salah';
            } catch(e) { area.innerHTML = 'Error'; }
        }
        loadPhotos();
    </script>
</body>
</html>